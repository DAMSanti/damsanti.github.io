<!DOCTYPE html>
<html>
<head>
    <title>Seleccionar archivo .java</title>
    <!-- Carga los estilos y scripts de CodeMirror -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.63.1/mode/clike/clike.min.js"></script>
    <style>
        /* Estilos para el área de CodeMirror */
        #javaCodeEditorContainer {
            flex: 1;
            overflow: auto;
        }
    </style>
</head>
<body>
    <h1>Selecciona un ejercicio:</h1>
    <select id="unidadSelect">
        <option value="">Selecciona una unidad</option>
    </select>

    <select id="hojaSelect">
        <option value="">Selecciona una hoja</option>
    </select>

    <select id="ejercicioSelect">
        <option value="">Selecciona un ejercicio</option>
    </select>
    
    <br>
    <!-- Reemplaza el textarea por el editor de CodeMirror -->
    <div id="javaCodeEditorContainer"></div>
    <br>

    <hr>
    
    <button onclick="loadAndRunJava()">Run</button>

    <h1>Salida:</h1>
    <pre id="output"></pre>

    <script>
        const unidadSelect = document.getElementById('unidadSelect');
        const hojaSelect = document.getElementById('hojaSelect');
        const ejercicioSelect = document.getElementById('ejercicioSelect');
        const javaCodeTextarea = document.getElementById('javaCode');
        const javaCodeEditorContainer = document.getElementById('javaCodeEditor');
        const output = document.getElementById('output');
        let selectedJarFile = ''; // Variable para almacenar el nombre del archivo .jar
        let selectedPath = '';
        let codeMirrorInstance = null;
        
        // Función para cargar y mostrar el código Java seleccionado
        unidadSelect.addEventListener('change', loadHojas);
        hojaSelect.addEventListener('change', loadEjercicios);
        ejercicioSelect.addEventListener('change', loadJavaCode);

        // Cargar las unidades disponibles al cargar la página
        window.addEventListener('load', () => {
            fetch('/data/lista-archivos-java.json') // Reemplaza con la ruta de tu servidor para obtener la lista de archivos
                .then(response => response.json())
                .then(data => {
                    const unidades = [...new Set(data.map(file => file.unidad))];
                    unidades.forEach(unidad => {
                        const option = document.createElement('option');
                        option.value = unidad;
                        option.textContent = unidad;
                        unidadSelect.appendChild(option);
                    });
                })
                .catch(error => {
                    console.error(error);
                });
        });

        // Cargar las hojas disponibles cuando se selecciona una unidad
        function loadHojas() {
            const selectedUnidad = unidadSelect.value;
            hojaSelect.innerHTML = '<option value="">Selecciona una hoja</option>'; // Limpiar las opciones anteriores

            if (selectedUnidad) {
                fetch('/data/lista-archivos-java.json') // Reemplaza con la ruta de tu servidor para obtener la lista de archivos
                    .then(response => response.json())
                    .then(data => {
                        const hojas = [...new Set(data.filter(file => file.unidad === selectedUnidad).map(file => file.Hoja))];
                        hojas.forEach(hoja => {
                            const option = document.createElement('option');
                            option.value = hoja;
                            option.textContent = hoja;
                            hojaSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }
        }

        // Cargar los ejercicios disponibles cuando se selecciona una hoja
        function loadEjercicios() {
            const selectedUnidad = unidadSelect.value;
            const selectedHoja = hojaSelect.value;
            ejercicioSelect.innerHTML = '<option value="">Selecciona un ejercicio</option>'; // Limpiar las opciones anteriores

            if (selectedUnidad && selectedHoja) {
                fetch('/data/lista-archivos-java.json') // Reemplaza con la ruta de tu servidor para obtener la lista de archivos
                    .then(response => response.json())
                    .then(data => {
                        const ejercicios = data.filter(file => file.unidad === selectedUnidad && file.Hoja === selectedHoja);
                        ejercicios.forEach(ejercicio => {
                            const option = document.createElement('option');
                            option.value = ejercicio.nombre;
                            option.textContent = ejercicio.nombre.replace(/\.java$/, '');
                            ejercicioSelect.appendChild(option);
                        });
                    })
                    .catch(error => {
                        console.error(error);
                    });
            }
        }

        function loadJavaCode() {
            const selectedJavaFile = ejercicioSelect.value;
            if (selectedJavaFile) {
                fetch('/data/lista-archivos-java.json') // Reemplaza con la ruta de tu servidor para obtener la lista de archivos
                    .then(response => response.json())
                    .then(data => {
                        const selectedFileData = data.find(file => file.nombre === selectedJavaFile);
                        if (selectedFileData) {
                            selectedPath = selectedFileData.ruta;
                            selectedJarFile = selectedFileData.jar;
                            const fullJavaFilePath = `${selectedPath}${selectedJavaFile}`;
                            fetch(fullJavaFilePath)
                                .then(response => response.text())
                                .then(javaCode => {
                                    // Mostrar el editor de CodeMirror y ocultar el textarea
                                    javaCodeTextarea.style.display = 'none';
                                    javaCodeEditorContainer.style.display = 'block';

                                    // Crear una instancia de CodeMirror si aún no existe
                                    if (!codeMirrorInstance) {
                                        codeMirrorInstance = CodeMirror(javaCodeEditorContainer, {
                                            mode: 'text/x-java',
                                            lineNumbers: true,
                                            readOnly: true,
                                        });
                                    }

                                    // Establecer el código Java
                                    codeMirrorInstance.setValue(javaCode);
                                })
                                .catch(error => {
                                    console.error(error);
                                });
                        } else {
                            console.error('Datos del archivo no encontrados en el JSON.');
                        }
                    })
                    .catch(error => {
                        console.error(error);
                    });
            } else {
                // Limpiar el contenido del editor de CodeMirror si no se selecciona ningún ejercicio
                if (codeMirrorInstance) {
                    codeMirrorInstance.setValue('');
                }
                javaCodeTextarea.value = '';
            }
        }

        // Función para ejecutar el archivo .jar
        function loadAndRunJava() {
            const selectedJavaFile = ejercicioSelect.value;
            if (!selectedJavaFile) {
                alert('Selecciona un archivo .java primero.');
                return;
            }

            output.textContent = 'Ejecutando...';

            const fullJarFilePath = `codigo/${selectedPath}${selectedJarFile}`;
            fetch(fullJarFilePath)
                .then(response => response.text())
                .then(data => {
                    output.textContent = data;
                })
                .catch(error => {
                    console.error(error);
                    output.textContent = 'Error al ejecutar el archivo .jar.';
                });
        }
    </script>
</body>
</html>
